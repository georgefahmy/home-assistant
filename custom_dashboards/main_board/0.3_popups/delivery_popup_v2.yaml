type: vertical-stack
cards:
  - type: custom:bubble-card
    card_type: pop-up
    hash: "#deliveries_v2"
    name: Delivery Details
    show_header: true
    icon: mdi:package-variant
    sub_button:
      - entity: sensor.parcel_active_shipment
        show_state: true
        state_background: true
        show_background: true
        show_attribute: false
        show_last_changed: false
        show_name: false
    styles: |-
      .bubble-button-card-container {
        background: rgb(33, 117, 186) !important;
      }
    width_desktop: 60%
    bg_opacity: "30"
    bg_blur: "60"
    backdrop_blur: ""
    shadow_opacity: "50"
    margin_top_desktop: 20px
    margin_top_mobile: 10px
    tap_action:
      action: none
    double_tap_action:
      action: none
    hold_action:
      action: none
    button_action:
      tap_action:
        action: none
      double_tap_action:
        action: none
      hold_action:
        action: none
  - type: vertical-stack
    cards:
      - type: entities
        entities:
          - entity: input_text.parcel_name
          - entity: input_text.tracking_number_input
          - entity: input_text.parcel_carrier
      - show_name: false
        show_icon: true
        type: button
        icon: mdi:check
        name: Submit
        tap_action:
          action: perform-action
          perform_action: automation.trigger
          target:
            entity_id: automation.add_new_parcel
          data:
            skip_condition: false
        icon_height: 25px
        hold_action:
          action: none
  - type: custom:auto-entities
    card:
      type: entities
      title: üì¶ Packages
    filter:
      template: >
        {% set parcels = state_attr('sensor.parcel_raw_shipment_data', 'deliveries')
        or [] %} [

          {# === En Route === #}
          {% set enroute = parcels | selectattr('status_code', 'in', [2,3,4]) | list %}
          {% if enroute %}
            { "type": "section", "label": "üì¶ En Route" },
            {% for p in enroute %}
              {% set events = p.events or [] %}
              {% set latest = events[0] if events else {'event': 'No Events', 'date': '', 'location': ''} %}
              {
                "type": "custom:fold-entity-row",
                "head": {
                  "type": "custom:template-entity-row",
                  "entity": "sensor.parcel_raw_shipment_data",
                  "name": "[{{ p.carrier_code | upper }}] {{ p.description or 'Unknown Package' }} - {{ p.tracking_number }}",
                  "state": "{{ latest.event }}",
                  "secondary": "Latest update: {{ latest.date }}{% if latest.location %} @ {{ latest.location }}{% endif %}",
                  "icon": "mdi:truck-delivery"
                },
                "entities": [
                  {% for e in events %}
                    {
                      "type": "custom:template-entity-row",
                      "entity": "sensor.parcel_raw_shipment_data",
                      "name": "{{ e.date }}{% if e.location %} @ {{ e.location }}{% endif %}",
                      "state": "{{ e.event }}"
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                ]
              }{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}

          {# === Delivered === #}
          {% set delivered = parcels | selectattr('status_code', 'equalto', 0) | list %}
          {% if delivered %}
            ,{ "type": "section", "label": "‚úÖ Delivered" },
            {% for p in delivered %}
              {% set events = p.events or [] %}
              {% set latest = events[0] if events else {'event': 'No events', 'date': '', 'location': ''} %}
              {
                "type": "custom:fold-entity-row",
                "head": {
                  "type": "custom:template-entity-row",
                  "entity": "sensor.parcel_raw_shipment_data",
                  "name": "[{{ p.carrier_code | upper }}] {{ p.description or 'Unknown Package' }} - {{ p.tracking_number }}",
                  "state": "{{ latest.event }}",
                  "secondary": "Delivered: {{ latest.date }}{% if latest.location %} @ {{ latest.location }}{% endif %}",
                  "icon": "mdi:package-check"
                },
                "entities": [
                  {% for e in events %}
                    {
                      "type": "custom:template-entity-row",
                      "entity": "sensor.parcel_raw_shipment_data",
                      "name": "{{ e.date }}{% if e.location %} @ {{ e.location }}{% endif %}",
                      "state": "{{ e.event }}"
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                ]
              }{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}

          {# === Frozen === #}
          {% set frozen = parcels | selectattr('status_code', 'equalto', 1) | list %}
          {% if frozen %}
            ,{ "type": "section", "label": "‚ùÑÔ∏è Frozen" },
            {% for p in frozen %}
              {% set events = p.events or [] %}
              {% set latest = events[0] if events else {'event': 'No events', 'date': '', 'location': ''} %}
              {
                "type": "custom:fold-entity-row",
                "head": {
                  "type": "custom:template-entity-row",
                  "entity": "sensor.parcel_raw_shipment_data",
                  "name": "[{{ p.carrier_code | upper }}] {{ p.description or 'Onbekend pakket' }} - {{ p.tracking_number }}",
                  "state": "{{ latest.event }}",
                  "secondary": "Frozen: {{ latest.date }}{% if latest.location %} @ {{ latest.location }}{% endif %}",
                  "icon": "mdi:snowflake-alert"
                },
                "entities": [
                  {% for e in events %}
                    {
                      "type": "custom:template-entity-row",
                      "entity": "sensor.parcel_raw_shipment_data",
                      "name": "{{ e.date }}{% if e.location %} @ {{ e.location }}{% endif %}",
                      "state": "{{ e.event }}"
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                ]
              }{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}

          {# === Exception === #}
          {% set exception = parcels | selectattr('status_code', 'in', [5,6,7]) | list %}
          {% if exception %}
            ,{ "type": "section", "label": "‚ùó Exception" },
            {% for p in exception %}
              {% set events = p.events or [] %}
              {% set latest = events[0] if events else {'event': 'No events', 'date': '', 'location': ''} %}
              {
                "type": "custom:fold-entity-row",
                "head": {
                  "type": "custom:template-entity-row",
                  "entity": "sensor.parcel_raw_shipment_data",
                  "name": "[{{ p.carrier_code | upper }}] {{ p.description or 'Unknown Package' }} - {{ p.tracking_number }}",
                  "state": "{{ latest.event }}",
                  "secondary": "Notification: {{ latest.date }}{% if latest.location %} @ {{ latest.location }}{% endif %}",
                  "icon": "mdi:alert-circle-outline"
                },
                "entities": [
                  {% for e in events %}
                    {
                      "type": "custom:template-entity-row",
                      "entity": "sensor.parcel_raw_shipment_data",
                      "name": "{{ e.date }}{% if e.location %} @ {{ e.location }}{% endif %}",
                      "state": "{{ e.event }}"
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                ]
              }{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}

          {# === Info Received === #}
          {% set info = parcels | selectattr('status_code', 'equalto', 8) | list %}
          {% if info %}
            ,{ "type": "section", "label": "üìã Info Received" },
            {% for p in info %}
              {% set events = p.events or [] %}
              {% set latest = events[0] if events else {'event': 'No Updates Yet', 'date': '', 'location': ''} %}
              {
                "type": "custom:fold-entity-row",
                "head": {
                  "type": "custom:template-entity-row",
                  "entity": "sensor.parcel_raw_shipment_data",
                  "name": "[{{ p.carrier_code | upper }}] {{ p.description or 'Unknown Package' }} - {{ p.tracking_number }}",
                  "state": "{{ latest.event }}",
                  "secondary": "Received: {{ latest.date }}{% if latest.location %} @ {{ latest.location }}{% endif %}",
                  "icon": "mdi:clipboard-text"
                },
                "entities": [
                  {% for e in events %}
                    {
                      "type": "custom:template-entity-row",
                      "entity": "sensor.parcel_raw_shipment_data",
                      "name": "{{ e.date }}{% if e.location %} @ {{ e.location }}{% endif %}",
                      "state": "{{ e.event }}"
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                ]
              }{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}

          {# === Placeholder === #}
          {% set placeholder = parcels | selectattr('carrier_code', 'equalto', 'pholder') | list %}
          {% if placeholder %}
            ,{ "type": "section", "label": "üî≥ Placeholder" },
            {% for p in placeholder %}
              {
                "type": "custom:template-entity-row",
                "entity": "sensor.parcel_raw_shipment_data",
                "name": "[PHOLDER] {{ p.description or 'Temporary Package' }} - {{ p.tracking_number }}",
                "state": "Placeholder",
                "icon": "mdi:feature-search-outline"
              }{% if not loop.last %},{% endif %}
            {% endfor %}
          {% endif %}

        ]
    show_empty: true
    grid_options:
      columns: 24
      rows: auto
